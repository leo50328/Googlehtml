<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML é›²ç«¯åŸ·è¡Œå™¨</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-bg: #252526;
            --tab-bg: #2d2d2d;
            --border-color: #333;
            --accent-color: #4285F4;
            --line-num-color: #858585;
            
            /* Syntax Highlight */
            --hl-tag: #569cd6; --hl-attr: #9cdcfe; --hl-string: #ce9178;
            --hl-comment: #6a9955;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: #ccc;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- å·¥å…·åˆ— --- */
        .toolbar {
            background: var(--sidebar-bg);
            padding: 8px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            height: 40px;
            z-index: 10;
        }

        .switch-container { display: flex; align-items: center; gap: 8px; margin-right: 10px; padding-right: 10px; border-right: 1px solid #444; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        .icon-btn {
            background: transparent; border: 1px solid transparent; color: #ccc; font-size: 18px; width: 36px; height: 36px;
            border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .icon-btn:hover { background: #3c3c3c; color: white; }
        
        body.cloud-mode .mode-sensitive { color: var(--accent-color); }
        .spacer { flex-grow: 1; }
        #user-avatar { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #555; display: none; cursor: pointer; }

        /* --- ç·¨è¼¯å€ä½ˆå±€ --- */
        .tabs-bar { background: var(--sidebar-bg); display: flex; gap: 1px; padding-top: 5px; overflow-x: auto; }
        .tab { padding: 8px 20px; background: var(--tab-bg); color: #888; font-size: 13px; cursor: pointer; min-width: 80px; user-select: none; text-align: center; }
        .tab.active { background: #1e1e1e; color: white; border-top: 2px solid var(--accent-color); }
        
        .main-editor-container {
            display: flex;
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        /* è¡Œè™Ÿæ¬„ */
        .line-numbers {
            width: 45px;
            background: #1e1e1e;
            color: var(--line-num-color);
            font-family: 'Consolas', monospace;
            font-size: 14px;
            line-height: 21px; /* å¿…é ˆèˆ‡ textarea ä¸€è‡´ */
            padding: 20px 5px;
            text-align: right;
            border-right: 1px solid #333;
            user-select: none;
            overflow: hidden;
        }

        .editor-box { position: relative; flex-grow: 1; overflow: hidden; }
        
        textarea, pre {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 20px; box-sizing: border-box; font-family: 'Consolas', monospace;
            font-size: 14px; line-height: 21px; white-space: pre; border: none; background: transparent;
            outline: none; color: transparent; caret-color: white; resize: none;
        }
        pre { z-index: 1; color: #d4d4d4; pointer-events: none; }
        textarea { z-index: 2; }

        /* Syntax Highlight Colors */
        .hl-tag { color: var(--hl-tag); } .hl-attr { color: var(--hl-attr); }
        .hl-string { color: var(--hl-string); } .hl-comment { color: var(--hl-comment); font-style: italic; }
        
        .statusbar { background: #007acc; color: white; padding: 3px 10px; font-size: 12px; display: flex; justify-content: space-between; }
        
        #ctx-menu { position: absolute; display: none; background: #252526; border: 1px solid #454545; z-index: 999; padding: 5px 0; min-width: 140px; }
        .ctx-item { padding: 8px 15px; color: #ccc; cursor: pointer; font-size: 13px; }
        .ctx-item:hover { background: #094771; color: white; }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="switch-container" title="åˆ‡æ›æ¨¡å¼ï¼šæœ¬æ©Ÿ / é›²ç«¯">
            <label class="switch">
                <input type="checkbox" id="cloud-switch" onchange="toggleCloudMode()">
                <span class="slider"></span>
            </label>
            <span id="mode-icon">ğŸ’»</span>
        </div>

        <button id="btn-import" class="icon-btn mode-sensitive" onclick="handleImport()" title="åŒ¯å…¥æª”æ¡ˆ">ğŸ“‚</button>
        <button id="btn-export" class="icon-btn mode-sensitive" onclick="handleExport()" title="å„²å­˜æª”æ¡ˆ">ğŸ’¾</button>
        
        <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>

        <button class="icon-btn" onclick="executeCode()" title="åŸ·è¡Œç¶²é ">â–¶ï¸</button>
        <button class="icon-btn" onclick="searchCode()" title="æœå°‹å…§å®¹ (Ctrl+F)">ğŸ”</button>
        <button class="icon-btn" onclick="pasteCode()" title="è²¼ä¸Š">ğŸ“‹</button>
        <button class="icon-btn" onclick="copyCode()" title="è¤‡è£½">ğŸ“„</button>
        <button class="icon-btn" onclick="clearCode()" title="æ¸…ç©ºå…§å®¹">ğŸ—‘ï¸</button>
        
        <div class="spacer"></div>
        <img id="user-avatar" src="" title="Google å¸³è™Ÿ (é»æ“Šç™»å‡º)" onclick="logoutGoogle()">
    </div>

    <div class="tabs-bar">
        <div id="tabs-list" style="display:flex;"></div>
        <button class="icon-btn" style="width:30px; height:30px; font-size:16px;" onclick="addNewTab()" title="æ–°å¢åˆ†é ">+</button>
    </div>

    <div class="main-editor-container">
        <div id="line-numbers" class="line-numbers">1</div>
        
        <div class="editor-box">
            <pre id="hl-layer"></pre>
            <textarea id="editor" spellcheck="false" placeholder="è«‹è¼¸å…¥ HTML..."></textarea>
        </div>
    </div>

    <div class="statusbar">
        <span id="status-msg">å°±ç·’</span>
        <span id="file-info">index.html</span>
    </div>

    <div id="ctx-menu">
        <div class="ctx-item" onclick="renameTab()">âœï¸ é‡å‘½å</div>
        <div class="ctx-item" onclick="closeTab()">âŒ é—œé–‰åˆ†é </div>
    </div>

<script>
    /* --- å¸¸æ•¸è¨­å®š --- */
    const CLIENT_ID = '990557557612-vd1h80orjn7676d28v9ss1v1fope1vgi.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAv3opO-MHMy8AOlQ0iw5y8Wy2zdlenq0Q';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile';

    let tokenClient, accessToken = null, pickerLoaded = false;
    let isCloudMode = false;
    let files = [{ name: 'index.html', content: '' }];
    let activeIdx = 0, ctxIdx = -1;

    const editor = document.getElementById('editor');
    const hlLayer = document.getElementById('hl-layer');
    const lineNumBox = document.getElementById('line-numbers');

    /* --- 1. æ ¸å¿ƒåŠŸèƒ½ï¼šè¡Œè™Ÿèˆ‡åŒæ­¥ --- */
    function updateEditor() {
        const text = editor.value;
        
        // æ›´æ–°è¡Œè™Ÿ
        const lines = text.split('\n').length;
        let lineNumbersHTML = '';
        for (let i = 1; i <= lines; i++) {
            lineNumbersHTML += i + '<br>';
        }
        lineNumBox.innerHTML = lineNumbersHTML;

        // æ›´æ–°èªæ³•äº®é«˜
        let c = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        c = c.replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="hl-comment">$1</span>')
             .replace(/("[^"]*")/g, '<span class="hl-string">$1</span>')
             .replace(/(&lt;\/?)(\w+)(.*?)(\/?&gt;)/g, (m,p1,p2,p3,p4) => 
                `<span class="hl-tag">${p1}${p2}</span>${p3.replace(/(\s+)([a-zA-Z0-9-]+)(=)/g, '$1<span class="hl-attr">$2</span>$3')}<span class="hl-tag">${p4}</span>`
             );
        hlLayer.innerHTML = c + '\n';
        
        // åŒæ­¥æ»¾å‹•
        syncScroll();
    }

    function syncScroll() {
        hlLayer.scrollTop = editor.scrollTop;
        hlLayer.scrollLeft = editor.scrollLeft;
        lineNumBox.scrollTop = editor.scrollTop; // è¡Œè™Ÿä¹Ÿè¦åŒæ­¥æ»¾å‹•
    }

    /* --- 2. æ ¸å¿ƒåŠŸèƒ½ï¼šæœå°‹ --- */
    function searchCode() {
        const query = prompt("æœå°‹ç¨‹å¼ç¢¼ï¼š");
        if (!query) return;

        const content = editor.value;
        const index = content.indexOf(query);

        if (index !== -1) {
            // é¸å–æ‰¾åˆ°çš„æ–‡å­—
            editor.focus();
            editor.setSelectionRange(index, index + query.length);
            
            // è‡ªå‹•æ»¾å‹•åˆ°è©²ä½ç½®
            const lineHeight = 21;
            const linesBefore = content.substring(0, index).split('\n').length;
            editor.scrollTop = (linesBefore - 1) * lineHeight - 50; 
            showMsg(`æ‰¾åˆ°å…§å®¹æ–¼ç¬¬ ${linesBefore} è¡Œ`);
        } else {
            alert("æ‰¾ä¸åˆ°ç›¸ç¬¦çš„å…§å®¹");
        }
    }

    /* --- 3. é›²ç«¯èˆ‡æª”æ¡ˆé‚è¼¯ (æ²¿ç”¨ä¸¦å„ªåŒ–) --- */
    async function toggleCloudMode() {
        isCloudMode = document.getElementById('cloud-switch').checked;
        if (isCloudMode && !accessToken) {
            await initAuth();
            if (!accessToken) { document.getElementById('cloud-switch').checked = false; isCloudMode = false; return; }
        }
        document.body.classList.toggle('cloud-mode', isCloudMode);
        document.getElementById('mode-icon').textContent = isCloudMode ? 'â˜ï¸' : 'ğŸ’»';
        showMsg(isCloudMode ? "é›²ç«¯æ¨¡å¼å·²å•Ÿç”¨" : "æœ¬æ©Ÿæ¨¡å¼å·²å•Ÿç”¨");
    }

    async function initAuth() {
        return new Promise((resolve) => {
            tokenClient.callback = async (resp) => {
                if (resp.error) resolve(false);
                accessToken = resp.access_token;
                fetchProfile(); resolve(true);
            };
            tokenClient.requestAccessToken({ prompt: 'consent' });
        });
    }

    async function initGoogleLib() {
        tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' });
        await new Promise(r => gapi.load('client:picker', r));
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
        pickerLoaded = true;
    }

    async function fetchProfile() {
        try {
            const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': `Bearer ${accessToken}` } });
            const data = await res.json();
            const avatar = document.getElementById('user-avatar');
            avatar.src = data.picture; avatar.style.display = 'block';
        } catch(e) {}
    }

    function logoutGoogle() {
        if(confirm('ç™»å‡º Google?')) {
            accessToken = null; document.getElementById('user-avatar').style.display = 'none';
            document.getElementById('cloud-switch').checked = false; toggleCloudMode();
        }
    }

    /* --- 4. ç·¨è¼¯èˆ‡åˆ†é å‹•ä½œ --- */
    function handleImport() { isCloudMode ? openFromDrive() : importLocal(); }
    function handleExport() { isCloudMode ? saveToDrive() : exportLocal(); }
    function showMsg(msg) { document.getElementById('status-msg').textContent = msg; }

    function importLocal() {
        const input = document.createElement('input'); input.type = 'file';
        input.onchange = e => {
            const f = e.target.files[0]; const r = new FileReader();
            r.onload = ev => { files.push({ name: f.name, content: ev.target.result }); switchTab(files.length - 1); };
            r.readAsText(f);
        }; input.click();
    }
    function exportLocal() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([editor.value], {type: 'text/html'}));
        a.download = files[activeIdx].name; a.click();
    }

    function openFromDrive() {
        if (!pickerLoaded) return;
        const picker = new google.picker.PickerBuilder()
            .addView(new google.picker.DocsView().setMimeTypes('text/html,text/plain'))
            .setOAuthToken(accessToken).setDeveloperKey(API_KEY)
            .setCallback(async (data) => {
                if (data.action === google.picker.Action.PICKED) {
                    const id = data.docs[0].id; showMsg("ä¸‹è¼‰ä¸­...");
                    const res = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, { headers: {'Authorization': `Bearer ${accessToken}`} });
                    files.push({ name: data.docs[0].name, content: await res.text() });
                    switchTab(files.length - 1);
                }
            }).build();
        picker.setVisible(true);
    }

    function saveToDrive() {
        if (!pickerLoaded) return;
        const picker = new google.picker.PickerBuilder()
            .addView(new google.picker.DocsView(google.picker.ViewId.FOLDERS).setSelectFolderEnabled(true))
            .setOAuthToken(accessToken).setDeveloperKey(API_KEY).setTitle("é¸æ“‡å„²å­˜è³‡æ–™å¤¾")
            .setCallback(async (data) => {
                if (data.action === google.picker.Action.PICKED) {
                    showMsg("å„²å­˜ä¸­...");
                    const meta = { name: files[activeIdx].name, mimeType: 'text/html', parents: [data.docs[0].id] };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(meta)], {type: 'application/json'}));
                    form.append('file', new Blob([editor.value], {type: 'text/html'}));
                    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: {'Authorization': `Bearer ${accessToken}`}, body: form });
                    showMsg("å„²å­˜æˆåŠŸ");
                }
            }).build();
        picker.setVisible(true);
    }

    /* --- 5. ä»‹é¢æ¸²æŸ“èˆ‡åˆå§‹åŒ– --- */
    function renderTabs() {
        const list = document.getElementById('tabs-list'); list.innerHTML = '';
        files.forEach((f, i) => {
            const div = document.createElement('div');
            div.className = `tab ${i === activeIdx ? 'active' : ''}`;
            div.textContent = f.name;
            div.onclick = () => switchTab(i);
            div.oncontextmenu = e => { e.preventDefault(); ctxIdx = i; const m=document.getElementById('ctx-menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; };
            list.appendChild(div);
        });
        document.getElementById('file-info').textContent = files[activeIdx].name;
    }

    function switchTab(i) { files[activeIdx].content = editor.value; activeIdx = i; editor.value = files[activeIdx].content; renderTabs(); updateEditor(); }
    function addNewTab() { files.push({ name: 'new.html', content: '' }); switchTab(files.length - 1); }
    function renameTab() { const n = prompt("æ–°åç¨±", files[ctxIdx].name); if(n){ files[ctxIdx].name=n; renderTabs(); } }
    function closeTab() { if(files.length>1 && confirm("ç¢ºå®šé—œé–‰?")){ files.splice(ctxIdx,1); if(activeIdx>=files.length)activeIdx=files.length-1; switchTab(activeIdx); } }

    async function pasteCode() { const text = await navigator.clipboard.readText(); const start = editor.selectionStart; editor.value = editor.value.substring(0, start) + text + editor.value.substring(editor.selectionEnd); updateEditor(); }
    function copyCode() { navigator.clipboard.writeText(editor.value); showMsg("å·²è¤‡è£½"); }
    function clearCode() { if(confirm("æ¸…ç©º?")){ editor.value=''; updateEditor(); } }
    function executeCode() { const w=window.open(); w.document.write(editor.value); }

    // äº‹ä»¶ç›£è½
    editor.addEventListener('input', updateEditor);
    editor.addEventListener('scroll', syncScroll);
    editor.addEventListener('keydown', e => { 
        if(e.key==='Tab'){ e.preventDefault(); document.execCommand('insertText', false, '    '); }
        if(e.ctrlKey && e.key === 'f') { e.preventDefault(); searchCode(); }
    });
    document.onclick = e => { if(!e.target.closest('#ctx-menu')) document.getElementById('ctx-menu').style.display='none'; };

    window.onload = () => { initGoogleLib(); renderTabs(); updateEditor(); };
</script>
</body>
</html>
