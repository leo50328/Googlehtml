<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML é›²ç«¯åŸ·è¡Œå™¨ PRO</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-bg: #252526;
            --tab-bg: #2d2d2d;
            --tab-active: #1e1e1e;
            --border-color: #333;
            --text-color: #ccc;
            --accent-color: #0e639c; /* VS Code Blue */
            
            /* èªæ³•äº®é«˜ */
            --hl-tag: #569cd6;
            --hl-attr: #9cdcfe;
            --hl-string: #ce9178;
            --hl-comment: #6a9955;
            --hl-keyword: #c586c0;
            --hl-number: #b5cea8;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- é ‚éƒ¨å·¥å…·åˆ— --- */
        .toolbar {
            background: var(--sidebar-bg);
            padding: 8px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            background: #3c3c3c;
            color: white;
            border: 1px solid #444;
            padding: 5px 12px;
            font-size: 13px;
            cursor: pointer;
            border-radius: 3px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn:hover:not(:disabled) { background: #505050; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-blue { background: var(--accent-color); border-color: var(--accent-color); }
        .btn-blue:hover:not(:disabled) { background: #1177bb; }
        .btn-green { background: #388a34; border-color: #388a34; }
        
        .divider { width: 1px; height: 20px; background: #444; margin: 0 5px; }

        /* --- åˆ†é åˆ— --- */
        .tabs-bar {
            background: var(--sidebar-bg);
            display: flex;
            align-items: flex-end;
            padding-left: 0;
            gap: 1px;
            height: 35px;
            overflow-x: auto;
        }
        
        .tab {
            padding: 8px 20px;
            background: var(--tab-bg);
            color: #969696;
            font-size: 13px;
            cursor: pointer;
            border-right: 1px solid var(--border-color);
            min-width: 100px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .tab:hover { background: #2a2d2e; }
        
        .tab.active {
            background: var(--tab-active);
            color: white;
            border-top: 2px solid var(--accent-color);
        }

        .tab-add-btn {
            background: transparent; border: none; color: #ccc;
            font-size: 18px; padding: 0 15px; cursor: pointer;
        }
        .tab-add-btn:hover { color: white; background: #333; }

        /* --- ç·¨è¼¯å™¨ --- */
        .editor-container {
            position: relative;
            flex-grow: 1;
            background: var(--bg-color);
        }

        textarea, pre {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            margin: 0; padding: 20px;
            box-sizing: border-box;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre;
            overflow: auto;
            border: none;
        }

        textarea {
            z-index: 2; color: transparent; background: transparent;
            caret-color: white; outline: none; resize: none;
        }
        pre { z-index: 1; color: #d4d4d4; pointer-events: none; }

        /* èªæ³•äº®é«˜ CSS */
        .hl-tag { color: var(--hl-tag); }
        .hl-attr { color: var(--hl-attr); }
        .hl-string { color: var(--hl-string); }
        .hl-comment { color: var(--hl-comment); font-style: italic; }
        .hl-keyword { color: var(--hl-keyword); }
        .hl-number { color: var(--hl-number); }
        .hl-bracket { color: #808080; }

        /* --- åº•éƒ¨ç‹€æ…‹åˆ— --- */
        .statusbar {
            background: #007acc;
            color: white;
            padding: 3px 10px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        /* --- å³éµé¸å–® (Context Menu) --- */
        #context-menu {
            position: absolute;
            display: none;
            background: #252526;
            border: 1px solid #454545;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            z-index: 1000;
            min-width: 150px;
            padding: 5px 0;
            border-radius: 4px;
        }
        .menu-item {
            padding: 8px 15px;
            font-size: 13px;
            color: #cccccc;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .menu-item:hover { background: #094771; color: white; }
        
        /* Google Picker èƒŒæ™¯é®ç½©åŠ æ·± */
        .picker-dialog-bg { background-color: rgba(0,0,0,0.85) !important; }
    </style>
</head>
<body>

    <div class="toolbar">
        <button id="auth-btn" class="btn btn-blue" onclick="toggleAuth()">ğŸ”‘ ç™»å…¥ Google</button>
        <div class="divider"></div>
        <button id="save-btn" class="btn" onclick="saveToDrive()" disabled>â˜ï¸ é›²ç«¯å„²å­˜ (é¸ä½ç½®)</button>
        <button id="open-btn" class="btn" onclick="openFromDrive()" disabled>ğŸ“‚ é›²ç«¯é–‹å•Ÿ</button>
        <div class="divider"></div>
        <button class="btn" onclick="executeCode()">â–¶ï¸ åŸ·è¡Œ</button>
        <button class="btn" onclick="copyCode()">ğŸ“‹ è¤‡è£½</button>
        <button class="btn" onclick="clearCode()">ğŸ—‘ï¸ æ¸…ç©º</button>
    </div>

    <div class="tabs-bar">
        <div id="tabs-container" style="display:flex;"></div>
        <button class="tab-add-btn" onclick="addNewTab()">+</button>
    </div>

    <div class="editor-container">
        <pre id="highlighting"></pre>
        <textarea id="editor" spellcheck="false" placeholder="åœ¨æ­¤è¼¸å…¥ç¨‹å¼ç¢¼..."></textarea>
    </div>

    <div class="statusbar">
        <span id="status-text">ç³»çµ±å°±ç·’</span>
        <span id="file-name">index.html</span>
    </div>

    <div id="context-menu">
        <div class="menu-item" onclick="renameCurrentTab()">âœï¸ é‡å‘½å</div>
        <div class="menu-item" onclick="closeCurrentTab()">âŒ é—œé–‰åˆ†é </div>
        <div style="height:1px; background:#444; margin:4px 0;"></div>
        <div class="menu-item" onclick="saveToDrive()">â˜ï¸ ä¸Šå‚³æ­¤æª”æ¡ˆ</div>
    </div>

<script>
    // === è¨­å®šèˆ‡è®Šæ•¸ ===
    const CLIENT_ID = '990557557612-vd1h80orjn7676d28v9ss1v1fope1vgi.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAv3opO-MHMy8AOlQ0iw5y8Wy2zdlenq0Q';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile';

    let tokenClient, accessToken = null, pickerApiLoaded = false;
    let files = [{ name: 'index.html', content: '' }];
    let activeIndex = 0;
    let contextMenuTargetIndex = -1; // è¨˜éŒ„å³éµé»æ“Šçš„æ˜¯å“ªå€‹åˆ†é 

    const editor = document.getElementById('editor');
    const highlighting = document.getElementById('highlighting');
    const statusText = document.getElementById('status-text');
    const contextMenu = document.getElementById('context-menu');

    // === Google API æ ¸å¿ƒ ===
    function showStatus(msg) { statusText.textContent = msg; setTimeout(()=>statusText.textContent='å°±ç·’', 4000); }

    async function initGoogle() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES,
            callback: (resp) => {
                if(resp.error) return;
                accessToken = resp.access_token;
                updateAuthUI(true);
                showStatus('ç™»å…¥æˆåŠŸ');
            }
        });
        await new Promise(r => gapi.load('client:picker', r));
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
        pickerApiLoaded = true;
    }

    function toggleAuth() {
        if(!accessToken) tokenClient.requestAccessToken({ prompt: 'consent' });
        else { accessToken = null; updateAuthUI(false); showStatus('å·²ç™»å‡º'); }
    }

    function updateAuthUI(isLogin) {
        document.getElementById('auth-btn').textContent = isLogin ? 'ğŸšª ç™»å‡º' : 'ğŸ”‘ ç™»å…¥ Google';
        document.getElementById('save-btn').disabled = !isLogin;
        document.getElementById('open-btn').disabled = !isLogin;
    }

    // === é›²ç«¯åŠŸèƒ½ (å«è³‡æ–™å¤¾é¸æ“‡) ===
    function saveToDrive() {
        if(!accessToken) return;
        const view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
            .setSelectFolderEnabled(true)
            .setMimeTypes('application/vnd.google-apps.folder');
        
        const picker = new google.picker.PickerBuilder()
            .addView(view)
            .setOAuthToken(accessToken)
            .setDeveloperKey(API_KEY)
            .setTitle('è«‹é¸æ“‡å„²å­˜è³‡æ–™å¤¾')
            .setCallback(async (data) => {
                if (data.action === google.picker.Action.PICKED) {
                    const folderId = data.docs[0].id;
                    await uploadFile(folderId, data.docs[0].name);
                }
            }).build();
        picker.setVisible(true);
    }

    async function uploadFile(folderId, folderName) {
        showStatus(`æ­£åœ¨ä¸Šå‚³è‡³ ${folderName}...`);
        const targetIndex = contextMenuTargetIndex !== -1 ? contextMenuTargetIndex : activeIndex;
        const file = files[targetIndex];
        const content = (targetIndex === activeIndex) ? editor.value : file.content;

        const metadata = { name: file.name, mimeType: 'text/html', parents: [folderId] };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([content], { type: 'text/html' }));

        try {
            await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}` }, body: form
            });
            showStatus('âœ… å„²å­˜æˆåŠŸï¼');
        } catch(e) { showStatus('âŒ å„²å­˜å¤±æ•—'); }
        contextMenuTargetIndex = -1; // é‡ç½®
    }

    function openFromDrive() {
        if(!accessToken) return;
        const picker = new google.picker.PickerBuilder()
            .addView(new google.picker.DocsView().setMimeTypes('text/html,text/plain'))
            .setOAuthToken(accessToken)
            .setDeveloperKey(API_KEY)
            .setCallback(async (data) => {
                if(data.action === google.picker.Action.PICKED) {
                    const id = data.docs[0].id;
                    const name = data.docs[0].name;
                    showStatus('ä¸‹è¼‰ä¸­...');
                    const res = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    const text = await res.text();
                    
                    // æ–°å¢åˆ†é ä¸¦è¼‰å…¥
                    files.push({ name: name, content: text });
                    switchTab(files.length - 1);
                    showStatus(`å·²é–‹å•Ÿ ${name}`);
                }
            }).build();
        picker.setVisible(true);
    }

    // === åˆ†é ç³»çµ± (å³éµé¸å–®æ ¸å¿ƒ) ===
    function renderTabs() {
        const container = document.getElementById('tabs-container');
        container.innerHTML = '';
        files.forEach((file, idx) => {
            const div = document.createElement('div');
            div.className = `tab ${idx === activeIndex ? 'active' : ''}`;
            div.textContent = file.name;
            
            // å·¦éµï¼šåˆ‡æ›åˆ†é 
            div.onclick = () => switchTab(idx);

            // å³éµï¼šé–‹å•Ÿé¸å–®
            div.oncontextmenu = (e) => {
                e.preventDefault();
                contextMenuTargetIndex = idx; // é–å®šæ“ä½œç›®æ¨™
                showContextMenu(e.pageX, e.pageY);
            };

            container.appendChild(div);
        });
        document.getElementById('file-name').textContent = files[activeIndex].name;
    }

    function switchTab(idx) {
        files[activeIndex].content = editor.value; // å­˜èˆŠ
        activeIndex = idx;
        editor.value = files[activeIndex].content; // è®€æ–°
        renderTabs();
        updateHighlight();
    }

    function addNewTab() {
        files.push({ name: 'new.html', content: '' });
        switchTab(files.length - 1);
    }

    // === å³éµé¸å–®é‚è¼¯ ===
    function showContextMenu(x, y) {
        contextMenu.style.display = 'block';
        contextMenu.style.left = x + 'px';
        contextMenu.style.top = y + 'px';
    }

    // é»æ“Šåˆ¥è™•é—œé–‰é¸å–®
    document.addEventListener('click', () => { contextMenu.style.display = 'none'; });

    // é‡å‘½ååŠŸèƒ½ (ä½¿ç”¨ Prompt æœ€ç©©)
    function renameCurrentTab() {
        if (contextMenuTargetIndex === -1) return;
        const currentName = files[contextMenuTargetIndex].name;
        const newName = prompt("è«‹è¼¸å…¥æ–°æª”æ¡ˆåç¨±ï¼š", currentName);
        if (newName && newName.trim() !== "") {
            files[contextMenuTargetIndex].name = newName.trim();
            renderTabs();
        }
    }

    function closeCurrentTab() {
        if (contextMenuTargetIndex === -1) return;
        if (files.length <= 1) { alert("ç„¡æ³•é—œé–‰æœ€å¾Œä¸€å€‹åˆ†é "); return; }
        if (confirm(`ç¢ºå®šåˆªé™¤ ${files[contextMenuTargetIndex].name}?`)) {
            files.splice(contextMenuTargetIndex, 1);
            if (activeIndex >= files.length) activeIndex = files.length - 1;
            switchTab(activeIndex);
        }
    }

    // === ç·¨è¼¯å™¨åŠŸèƒ½ ===
    function updateHighlight() {
        let code = editor.value;
        code = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        // ç°¡å–® Regex
        code = code.replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="hl-comment">$1</span>');
        code = code.replace(/("[^"]*")/g, '<span class="hl-string">$1</span>');
        code = code.replace(/(&lt;\/?)(\w+)(.*?)(\/?&gt;)/g, (m,p1,p2,p3,p4) => {
            let attrs = p3.replace(/(\s+)([a-zA-Z0-9-]+)(=)/g, '$1<span class="hl-attr">$2</span>$3');
            return `<span class="hl-bracket">${p1}</span><span class="hl-tag">${p2}</span>${attrs}<span class="hl-bracket">${p4}</span>`;
        });
        highlighting.innerHTML = code + '\n';
    }

    editor.addEventListener('input', updateHighlight);
    editor.addEventListener('scroll', () => {
        highlighting.scrollTop = editor.scrollTop;
        highlighting.scrollLeft = editor.scrollLeft;
    });
    editor.addEventListener('keydown', e => {
        if(e.key==='Tab'){ e.preventDefault(); document.execCommand('insertText', false, '    '); }
    });

    function executeCode() {
        const w = window.open();
        w.document.write(editor.value);
    }
    function copyCode() { navigator.clipboard.writeText(editor.value); showStatus('å·²è¤‡è£½'); }
    function clearCode() { if(confirm('æ¸…ç©º?')) { editor.value=''; updateHighlight(); } }

    window.onload = () => { initGoogle(); renderTabs(); updateHighlight(); };
</script>
</body>
</html>
