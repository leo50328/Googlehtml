<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML é›²ç«¯åŸ·è¡Œå™¨ Ultimate</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-bg: #252526;
            --tab-bg: #2d2d2d;
            --border-color: #333;
            --accent-color: #4285F4; /* Google Blue */
            --local-color: #555;      /* Local Gray */
            
            /* Syntax Highlight */
            --hl-tag: #569cd6; --hl-attr: #9cdcfe; --hl-string: #ce9178;
            --hl-comment: #6a9955; --hl-keyword: #c586c0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: #ccc;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- å·¥å…·åˆ— --- */
        .toolbar {
            background: var(--sidebar-bg);
            padding: 8px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            height: 40px;
        }

        /* é–‹é—œ Switch æ¨£å¼ */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 10px;
            padding-right: 10px;
            border-right: 1px solid #444;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px; width: 16px;
            left: 2px; bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* åœ–ç¤ºæŒ‰éˆ• */
        .icon-btn {
            background: transparent;
            border: 1px solid transparent;
            color: #ccc;
            font-size: 18px;
            width: 36px; height: 36px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .icon-btn:hover { background: #3c3c3c; border-color: #555; color: white; }
        .icon-btn:active { transform: translateY(1px); }
        
        /* é›²ç«¯æ¨¡å¼ä¸‹çš„æŒ‰éˆ•ç‰¹æ•ˆ */
        body.cloud-mode .mode-sensitive { color: var(--accent-color); }
        body.cloud-mode .mode-sensitive:hover { background: rgba(66, 133, 244, 0.2); border-color: var(--accent-color); }

        .spacer { flex-grow: 1; }

        #user-avatar {
            width: 28px; height: 28px; border-radius: 50%; 
            border: 2px solid #555; display: none; cursor: pointer;
        }

        /* --- åˆ†é èˆ‡ç·¨è¼¯å™¨ --- */
        .tabs-bar {
            background: var(--sidebar-bg);
            display: flex;
            gap: 1px;
            padding-top: 5px;
            overflow-x: auto;
        }
        .tab {
            padding: 8px 20px;
            background: var(--tab-bg);
            color: #888;
            font-size: 13px;
            cursor: pointer;
            min-width: 80px;
            user-select: none;
            display: flex; justify-content: center;
        }
        .tab.active { background: #1e1e1e; color: white; border-top: 2px solid var(--accent-color); }
        
        .editor-box { position: relative; flex-grow: 1; }
        textarea, pre {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 20px; box-sizing: border-box;
            font-family: 'Consolas', monospace; font-size: 14px;
            white-space: pre; border: none; background: transparent;
            outline: none; color: transparent; caret-color: white; resize: none;
        }
        pre { z-index: 1; color: #d4d4d4; pointer-events: none; }
        textarea { z-index: 2; }

        /* Syntax Highlight Colors */
        .hl-tag { color: var(--hl-tag); } .hl-attr { color: var(--hl-attr); }
        .hl-string { color: var(--hl-string); } .hl-comment { color: var(--hl-comment); font-style: italic; }
        
        .statusbar { background: #007acc; color: white; padding: 3px 10px; font-size: 12px; display: flex; justify-content: space-between; }

        /* å³éµé¸å–® */
        #ctx-menu {
            position: absolute; display: none; background: #252526;
            border: 1px solid #454545; z-index: 999; padding: 5px 0;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.5); min-width: 140px;
        }
        .ctx-item { padding: 8px 15px; color: #ccc; cursor: pointer; font-size: 13px; }
        .ctx-item:hover { background: #094771; color: white; }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="switch-container" title="åˆ‡æ›æ¨¡å¼ï¼šæœ¬æ©Ÿ / é›²ç«¯ (Google Drive)">
            <label class="switch">
                <input type="checkbox" id="cloud-switch" onchange="toggleCloudMode()">
                <span class="slider round"></span>
            </label>
            <span id="mode-icon">ğŸ’»</span>
        </div>

        <button id="btn-import" class="icon-btn mode-sensitive" onclick="handleImport()" title="åŒ¯å…¥æœ¬æ©Ÿæª”æ¡ˆ">ğŸ“‚</button>
        <button id="btn-export" class="icon-btn mode-sensitive" onclick="handleExport()" title="åŒ¯å‡º (ä¸‹è¼‰)">ğŸ’¾</button>
        
        <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>

        <button class="icon-btn" onclick="executeCode()" title="åŸ·è¡Œç¶²é ">â–¶ï¸</button>
        <button class="icon-btn" onclick="copyCode()" title="è¤‡è£½ç¨‹å¼ç¢¼">ğŸ“‹</button>
        <button class="icon-btn" onclick="clearCode()" title="æ¸…ç©ºå…§å®¹">ğŸ—‘ï¸</button>
        
        <div class="spacer"></div>
        <img id="user-avatar" src="" title="Google å¸³è™Ÿè³‡è¨Š (é»æ“Šç™»å‡º)" onclick="logoutGoogle()">
    </div>

    <div class="tabs-bar">
        <div id="tabs-list" style="display:flex;"></div>
        <button class="icon-btn" style="width:30px; height:30px; font-size:16px;" onclick="addNewTab()" title="æ–°å¢åˆ†é ">+</button>
    </div>

    <div class="editor-box">
        <pre id="hl-layer"></pre>
        <textarea id="editor" spellcheck="false" placeholder="è«‹è¼¸å…¥ HTML..."></textarea>
    </div>

    <div class="statusbar">
        <span id="status-msg">æœ¬æ©Ÿæ¨¡å¼</span>
        <span id="file-info">index.html</span>
    </div>

    <div id="ctx-menu">
        <div class="ctx-item" onclick="renameTab()">âœï¸ é‡å‘½å</div>
        <div class="ctx-item" onclick="closeTab()">âŒ é—œé–‰åˆ†é </div>
    </div>

<script>
    /* --- 1. æ ¸å¿ƒè®Šæ•¸ --- */
    const CLIENT_ID = '990557557612-vd1h80orjn7676d28v9ss1v1fope1vgi.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAv3opO-MHMy8AOlQ0iw5y8Wy2zdlenq0Q';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile';

    let tokenClient, accessToken = null, pickerLoaded = false;
    let isCloudMode = false;
    
    let files = [{ name: 'index.html', content: '' }];
    let activeIdx = 0;
    let ctxIdx = -1;

    const editor = document.getElementById('editor');
    const hlLayer = document.getElementById('hl-layer');
    
    /* --- 2. æ¨¡å¼åˆ‡æ›é‚è¼¯ --- */
    async function toggleCloudMode() {
        const checkbox = document.getElementById('cloud-switch');
        isCloudMode = checkbox.checked;
        const body = document.body;
        const modeIcon = document.getElementById('mode-icon');
        const btnImp = document.getElementById('btn-import');
        const btnExp = document.getElementById('btn-export');
        const status = document.getElementById('status-msg');

        if (isCloudMode) {
            // åˆ‡æ›ç‚ºé›²ç«¯
            if (!accessToken) {
                // è‹¥æœªç™»å…¥ï¼Œå˜—è©¦ç™»å…¥
                await initAuth();
                if (!accessToken) {
                    // ç™»å…¥å¤±æ•—æˆ–å–æ¶ˆï¼Œåˆ‡å›æœ¬æ©Ÿ
                    checkbox.checked = false;
                    isCloudMode = false;
                    return; 
                }
            }
            body.classList.add('cloud-mode');
            modeIcon.textContent = 'â˜ï¸';
            btnImp.title = "å¾ Google Drive é–‹å•Ÿ";
            btnExp.title = "å„²å­˜è‡³ Google Drive";
            status.textContent = "é›²ç«¯æ¨¡å¼ (Google Drive)";
        } else {
            // åˆ‡æ›ç‚ºæœ¬æ©Ÿ
            body.classList.remove('cloud-mode');
            modeIcon.textContent = 'ğŸ’»';
            btnImp.title = "åŒ¯å…¥æœ¬æ©Ÿæª”æ¡ˆ";
            btnExp.title = "åŒ¯å‡º (ä¸‹è¼‰)";
            status.textContent = "æœ¬æ©Ÿæ¨¡å¼";
        }
    }

    /* --- 3. çµ±ä¸€åŒ¯å…¥/åŒ¯å‡ºå…¥å£ --- */
    function handleImport() {
        if (isCloudMode) openFromDrive();
        else importLocal();
    }

    function handleExport() {
        if (isCloudMode) saveToDrive();
        else exportLocal();
    }

    /* --- 4. Google Auth & API --- */
    async function initAuth() {
        return new Promise((resolve) => {
            tokenClient.callback = async (resp) => {
                if (resp.error) resolve(false);
                accessToken = resp.access_token;
                await fetchProfile();
                resolve(true);
            };
            tokenClient.requestAccessToken({ prompt: 'consent' });
        });
    }

    async function initGoogleLib() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES, callback: '' // å‹•æ…‹æŒ‡å®š
        });
        await new Promise(r => gapi.load('client:picker', r));
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
        pickerLoaded = true;
    }

    async function fetchProfile() {
        try {
            const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const data = await res.json();
            const avatar = document.getElementById('user-avatar');
            avatar.src = data.picture;
            avatar.style.display = 'block';
        } catch(e) {}
    }

    function logoutGoogle() {
        if(confirm('è¦ç™»å‡º Google å¸³è™Ÿå—ï¼Ÿ')) {
            google.accounts.oauth2.revoke(accessToken, () => {
                accessToken = null;
                document.getElementById('user-avatar').style.display = 'none';
                document.getElementById('cloud-switch').checked = false;
                toggleCloudMode(); // è§¸ç™¼ UI æ›´æ–°å›æœ¬æ©Ÿ
            });
        }
    }

    /* --- 5. æª”æ¡ˆæ“ä½œå¯¦ä½œ --- */
    // Local
    function importLocal() {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = ev => {
                files.push({ name: f.name, content: ev.target.result });
                switchTab(files.length - 1);
            };
            r.readAsText(f);
        };
        input.click();
    }

    function exportLocal() {
        const blob = new Blob([editor.value], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = files[activeIdx].name;
        a.click();
    }

    // Cloud (Drive)
    function openFromDrive() {
        if (!pickerLoaded) return;
        const view = new google.picker.DocsView().setMimeTypes('text/html,text/plain');
        const picker = new google.picker.PickerBuilder()
            .addView(view).setOAuthToken(accessToken).setDeveloperKey(API_KEY)
            .setCallback(async (data) => {
                if (data.action === google.picker.Action.PICKED) {
                    const id = data.docs[0].id;
                    const name = data.docs[0].name;
                    const res = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, {
                        headers: {'Authorization': `Bearer ${accessToken}`}
                    });
                    const text = await res.text();
                    files.push({ name: name, content: text });
                    switchTab(files.length - 1);
                    document.getElementById('status-msg').textContent = `å·²å¾é›²ç«¯é–‹å•Ÿ: ${name}`;
                }
            }).build();
        picker.setVisible(true);
    }

    function saveToDrive() {
        if (!pickerLoaded) return;
        const view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
            .setSelectFolderEnabled(true).setMimeTypes('application/vnd.google-apps.folder');
        const picker = new google.picker.PickerBuilder()
            .addView(view).setOAuthToken(accessToken).setDeveloperKey(API_KEY)
            .setTitle("é¸æ“‡å„²å­˜è³‡æ–™å¤¾")
            .setCallback(async (data) => {
                if (data.action === google.picker.Action.PICKED) {
                    const folderId = data.docs[0].id;
                    const folderName = data.docs[0].name;
                    await upload(folderId, folderName);
                }
            }).build();
        picker.setVisible(true);
    }

    async function upload(folderId, folderName) {
        document.getElementById('status-msg').textContent = `ä¸Šå‚³ä¸­...`;
        const meta = { name: files[activeIdx].name, mimeType: 'text/html', parents: [folderId] };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(meta)], {type: 'application/json'}));
        form.append('file', new Blob([editor.value], {type: 'text/html'}));
        
        await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST', headers: {'Authorization': `Bearer ${accessToken}`}, body: form
        });
        document.getElementById('status-msg').textContent = `å·²å„²å­˜è‡³: ${folderName}`;
    }

    /* --- 6. ä»‹é¢èˆ‡åŠŸèƒ½ --- */
    function renderTabs() {
        const list = document.getElementById('tabs-list');
        list.innerHTML = '';
        files.forEach((f, i) => {
            const div = document.createElement('div');
            div.className = `tab ${i === activeIdx ? 'active' : ''}`;
            div.textContent = f.name;
            div.onclick = () => switchTab(i);
            div.oncontextmenu = e => {
                e.preventDefault(); ctxIdx = i;
                const menu = document.getElementById('ctx-menu');
                menu.style.display = 'block';
                menu.style.left = e.pageX + 'px'; menu.style.top = e.pageY + 'px';
            };
            list.appendChild(div);
        });
        document.getElementById('file-info').textContent = files[activeIdx].name;
    }

    function switchTab(i) {
        files[activeIdx].content = editor.value;
        activeIdx = i;
        editor.value = files[activeIdx].content;
        renderTabs(); highlight();
    }

    function addNewTab() {
        files.push({ name: 'new.html', content: '' });
        switchTab(files.length - 1);
    }

    function highlight() {
        let c = editor.value.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        c = c.replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="hl-comment">$1</span>')
             .replace(/("[^"]*")/g, '<span class="hl-string">$1</span>')
             .replace(/(&lt;\/?)(\w+)(.*?)(\/?&gt;)/g, (m,p1,p2,p3,p4) => 
                `<span class="hl-tag">${p1}${p2}</span>${p3.replace(/(\s+)([a-zA-Z0-9-]+)(=)/g, '$1<span class="hl-attr">$2</span>$3')}<span class="hl-tag">${p4}</span>`
             );
        hlLayer.innerHTML = c + '\n';
    }

    // Context Menu Actions
    function renameTab() {
        const name = prompt("æ–°åç¨±", files[ctxIdx].name);
        if(name) { files[ctxIdx].name = name; renderTabs(); }
    }
    function closeTab() {
        if(files.length > 1 && confirm("ç¢ºå®šé—œé–‰?")) {
            files.splice(ctxIdx, 1);
            if(activeIdx >= files.length) activeIdx = files.length - 1;
            switchTab(activeIdx);
        }
    }

    // Misc
    function executeCode() { const w = window.open(); w.document.write(editor.value); }
    function copyCode() { navigator.clipboard.writeText(editor.value); document.getElementById('status-msg').textContent = "å·²è¤‡è£½"; }
    function clearCode() { if(confirm("æ¸…ç©º?")) { editor.value=''; highlight(); } }

    document.onclick = e => { if(!e.target.closest('#ctx-menu')) document.getElementById('ctx-menu').style.display='none'; };
    editor.addEventListener('input', highlight);
    editor.addEventListener('scroll', () => { hlLayer.scrollTop = editor.scrollTop; hlLayer.scrollLeft = editor.scrollLeft; });
    editor.addEventListener('keydown', e => { if(e.key==='Tab'){ e.preventDefault(); document.execCommand('insertText', false, '    '); }});

    window.onload = () => { initGoogleLib(); renderTabs(); highlight(); };
</script>
</body>
</html>
